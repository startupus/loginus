name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H 45.144.176.42 >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no root@45.144.176.42 << 'EOF'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
            mkdir -p /root/loginus-new
            cd /root/loginus-new
            
            # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
            if [ -d .git ]; then
              echo "ðŸ“¥ Updating repository..."
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            else
              echo "ðŸ“¥ Cloning repository..."
              git clone https://github.com/teramisuslik/loginus-v2.git .
            fi
            
            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
            echo "ðŸ›‘ Stopping old containers..."
            docker-compose -f docker-compose.prod.yml down || true
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚
            echo "ðŸ”§ Running deployment script..."
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh
            
            echo "âœ… Deployment completed!"
          EOF
      
      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519

