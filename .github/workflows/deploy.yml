name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H 45.144.176.42 >> ~/.ssh/known_hosts
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          
          # –ö–æ–ø–∏—Ä—É–µ–º Deploy Key –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ scp (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
          scp -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ~/.ssh/id_ed25519 root@45.144.176.42:/root/.ssh/id_ed25519_github
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no root@45.144.176.42 "chmod 600 ~/.ssh/id_ed25519_github && echo 'Deploy Key —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ'"
      
      - name: Deploy to server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no root@45.144.176.42 << 'EOF'
            set -e
            
            echo "üöÄ Starting deployment..."
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            mkdir -p /root/loginus-new
            cd /root/loginus-new
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH –¥–ª—è GitHub –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if [ ! -f ~/.ssh/id_ed25519_github ]; then
              echo "‚ö†Ô∏è  Deploy Key not found on server, will try to clone via HTTPS with token"
            fi
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH config –¥–ª—è GitHub
            mkdir -p ~/.ssh
            cat > ~/.ssh/config << 'SSH_CONFIG'
            Host github.com
                HostName github.com
                User git
                IdentityFile ~/.ssh/id_ed25519_github
                StrictHostKeyChecking no
            SSH_CONFIG
            chmod 600 ~/.ssh/config
            
            # –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ -d .git ]; then
              echo "üì• Updating repository..."
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            else
              echo "üì• Cloning repository via SSH..."
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º SSH —Å Deploy Key
              git clone git@github.com:teramisuslik/loginus-v2.git . || {
                echo "‚ùå Failed to clone repository"
                exit 1
              }
            fi
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üõë Stopping old containers..."
            docker-compose -f docker-compose.prod.yml down || true
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π —Å–∫—Ä–∏–ø—Ç
            echo "üîß Running deployment script..."
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh
            
            echo "‚úÖ Deployment completed!"
          EOF
      
      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519

