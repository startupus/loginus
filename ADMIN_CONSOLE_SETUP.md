# Настройка доступа к административной консоли

## ✅ Проблема решена!

Исправлены следующие проблемы:
1. Убрано неверное значение по умолчанию `requiredRole = 'admin'` (такой роли не существует)
2. Добавлена проверка авторизации перед проверкой роли
3. Улучшено логирование для отладки

## Требования для доступа

Для доступа к админ-консоли необходимо:
1. **Быть авторизованным** (isAuthenticated: true)
2. **Иметь роль администратора** (super_admin, super_admin_staff, company_admin или company_admin_staff)

## Решение

### 1. Авторизация с ролью администратора

Для доступа к админ-консоли необходимо авторизоваться как пользователь с ролью администратора.

**Вариант 1: Использовать специальный номер для быстрого доступа**
- Номер: `+79091503444`
- Код: любой (в dev режиме) или `123456`
- Этот пользователь имеет роль `super_admin` в `users.json`

**Вариант 2: Использовать другой номер администратора**
- Номер: `+79001234568` (Алексей Петров - `company_admin`)
- Код: `123456` (в dev режиме)

### 2. Проверка роли в браузере

После авторизации проверьте в консоли браузера (DevTools):
```javascript
// В консоли браузера
localStorage.getItem('loginus-auth')
// Должен содержать поле "role": "super_admin" или другую роль админа
```

### 3. Ручная установка роли (для тестирования)

Если нужно быстро протестировать админ-консоль без повторной авторизации:

1. Откройте DevTools (F12)
2. Перейдите в Application/Storage → Local Storage
3. Найдите ключ `loginus-auth`
4. Измените JSON, добавив/изменив поле `role`:
```json
{
  "state": {
    "user": {
      "id": "1",
      "name": "Дмитрий Лукьян",
      "email": "lukyan.dmitriy@ya.ru",
      "phone": "+79091503444",
      "role": "super_admin",
      "companyId": null,
      "permissions": ["*"]
    },
    ...
  }
}
```
5. Обновите страницу

### 4. Доступные роли

- `super_admin` - Супер-админ SaaS сервиса (полный доступ)
- `super_admin_staff` - Сотрудники супер-админа
- `company_admin` - Админ компании (доступ только к своей компании)
- `company_admin_staff` - Сотрудники админа компании
- `user` - Обычный пользователь (нет доступа к админке)

### 5. Тестовые пользователи в users.json

1. **Дмитрий Лукьян** (`+79091503444`)
   - Роль: `super_admin`
   - Полный доступ ко всем функциям админки

2. **Алексей Петров** (`+79001234568`)
   - Роль: `company_admin`
   - Доступ только к своей компании (companyId: "1")

3. **Мария Сидорова** (`+79001234569`)
   - Роль: `company_admin_staff`
   - Ограниченный доступ

## После исправлений

После внесенных изменений:
1. При авторизации через `verifyCode` роль пользователя теперь сохраняется в authStore
2. При использовании специального номера `+79091503444` возвращается пользователь с ролью `super_admin`
3. При использовании DEV_CODE `123456` также возвращается роль пользователя (если пользователь существует)
4. ProfileService теперь возвращает роль из users.json
5. DashboardPage и DataPage больше не теряют роль при обновлении пользователя

## Отладка в консоли браузера

В dev режиме доступны утилиты для отладки:

```javascript
// Проверить текущую роль
window.adminDebug.checkRole()

// Установить роль (для тестирования)
window.adminDebug.setRole('super_admin')
```

## Проверка

1. **Авторизуйтесь** с номером `+79091503444` и кодом `123456`
2. **Проверьте роль** в консоли: `window.adminDebug.checkRole()`
3. **Если роль не установлена**, установите её: `window.adminDebug.setRole('super_admin')`
4. **Перейдите** на `/ru/admin`
5. **Проверьте консоль** - должны быть логи от AdminRoute с информацией о проверке прав
6. Должна открыться админ-консоль с виджетами

## Быстрый тест доступа

1. **Авторизуйтесь** с номером `+79091503444` и кодом `123456`
2. **Проверьте консоль** - должны быть логи: `[AdminRoute] Check: {userRole: 'super_admin', isAdmin: true, ...}`
3. **Перейдите** на `/ru/admin`
4. Должна открыться админ-консоль с виджетами

## Если все еще не работает

1. Откройте DevTools (F12) → Console
2. Проверьте логи `[AdminRoute]` - там будет видно причину отказа в доступе
3. Проверьте роль: `window.adminDebug.checkRole()`
4. Если роль не установлена, установите её: `window.adminDebug.setRole('super_admin')`
5. Проверьте localStorage: Application → Local Storage → `loginus-auth`
6. Убедитесь, что `isAuthenticated: true` и `role: "super_admin"`
7. Обновите страницу

## Что было исправлено

- ✅ Убрано неверное значение по умолчанию `requiredRole = 'admin'`
- ✅ Добавлена проверка `isAuthenticated` перед проверкой роли
- ✅ Улучшено логирование для отладки
- ✅ Редирект на `/auth` если пользователь не авторизован (вместо главной страницы)

