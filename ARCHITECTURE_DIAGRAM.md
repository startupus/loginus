# 🏗️ Архитектура системы аутентификации и безопасности

## 📊 Общая архитектура

```
┌─────────────────────────────────────────────────────────────────────┐
│                         FRONTEND (React)                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │   Admin Panel    │  │  Security Pages  │  │   Auth Pages     │  │
│  ├──────────────────┤  ├──────────────────┤  ├──────────────────┤  │
│  │                  │  │                  │  │                  │  │
│  │ AuthFlowBuilder  │  │ SecurityPage     │  │ LoginPage        │  │
│  │                  │  │ DevicesPage      │  │ RegisterPage     │  │
│  │ [Drag & Drop]    │  │ ActivityPage     │  │ [Dynamic Forms]  │  │
│  │                  │  │ RecoveryPage     │  │                  │  │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘  │
│           │                     │                      │             │
│           └─────────────────────┼──────────────────────┘             │
│                                 │                                    │
│  ┌──────────────────────────────┼────────────────────────────────┐  │
│  │                    API Services                                │  │
│  ├──────────────────────────────┼────────────────────────────────┤  │
│  │  authFlowApi      │  securityApi      │  authApi              │  │
│  │  - getAuthFlow    │  - getDevices     │  - login              │  │
│  │  - updateAuthFlow │  - deleteDevice   │  - register           │  │
│  │  - getPublicFlow  │  - getActivity    │  - refresh            │  │
│  │                   │  - changePassword │  - logout             │  │
│  └───────────────────┴───────────────────┴───────────────────────┘  │
│                                 │                                    │
└─────────────────────────────────┼────────────────────────────────────┘
                                  │
                                  │ HTTPS / REST API
                                  │
┌─────────────────────────────────┼────────────────────────────────────┐
│                         BACKEND (NestJS)                             │
├─────────────────────────────────┼────────────────────────────────────┤
│                                 │                                    │
│  ┌──────────────────────────────┼────────────────────────────────┐  │
│  │                      Controllers                               │  │
│  ├──────────────────────────────┼────────────────────────────────┤  │
│  │                              │                                 │  │
│  │  ┌────────────────┐  ┌───────┴────────┐  ┌─────────────────┐ │  │
│  │  │ AdminController│  │SecurityController│ │ AuthController  │ │  │
│  │  ├────────────────┤  ├────────────────┤  ├─────────────────┤ │  │
│  │  │ GET  /auth-flow│  │ GET  /devices  │  │ POST /register  │ │  │
│  │  │ PUT  /auth-flow│  │ DEL  /devices/:│  │ POST /login     │ │  │
│  │  │ POST /test-flow│  │ GET  /activity │  │ POST /refresh   │ │  │
│  │  │                │  │ POST /password │  │ GET  /flow      │ │  │
│  │  │                │  │ POST /logout-all│ │ POST /2fa       │ │  │
│  │  └────────┬───────┘  └───────┬────────┘  └────────┬────────┘ │  │
│  │           │                  │                     │          │  │
│  └───────────┼──────────────────┼─────────────────────┼──────────┘  │
│              │                  │                     │             │
│  ┌───────────┼──────────────────┼─────────────────────┼──────────┐  │
│  │                          Services                              │  │
│  ├───────────┼──────────────────┼─────────────────────┼──────────┤  │
│  │           │                  │                     │          │  │
│  │  ┌────────▼────────┐  ┌──────▼───────┐  ┌─────────▼────────┐ │  │
│  │  │  AdminService   │  │SecurityService│ │   AuthService    │ │  │
│  │  ├─────────────────┤  ├──────────────┤  ├──────────────────┤ │  │
│  │  │                 │  │              │  │                  │ │  │
│  │  │ getAuthFlow()   │  │ getDevices() │  │ register()       │ │  │
│  │  │ updateAuthFlow()│  │ deleteDevice│  │ login()          │ │  │
│  │  │                 │  │ getActivity()│  │ validateUser()   │ │  │
│  │  │                 │  │ changePwd()  │  │ generateTokens() │ │  │
│  │  │                 │  │ logoutAll()  │  │                  │ │  │
│  │  └─────────────────┘  └──────┬───────┘  └─────────┬────────┘ │  │
│  │                              │                     │          │  │
│  │  ┌──────────────────────────┼─────────────────────┼────────┐ │  │
│  │  │           Specialized Services                           │ │  │
│  │  ├──────────────────────────┼─────────────────────┼────────┤ │  │
│  │  │                          │                     │        │ │  │
│  │  │  ┌────────────┐  ┌───────▼─────┐  ┌──────────▼─────┐  │ │  │
│  │  │  │ NfaService │  │ EmailService│  │ AuditService   │  │ │  │
│  │  │  ├────────────┤  ├─────────────┤  ├────────────────┤  │ │  │
│  │  │  │            │  │             │  │                │  │ │  │
│  │  │  │ sendCodes()│  │ sendEmail() │  │ log()          │  │ │  │
│  │  │  │ verify()   │  │ sendCode()  │  │ getHistory()   │  │ │  │
│  │  │  │ configure()│  │             │  │                │  │ │  │
│  │  │  └────────────┘  └─────────────┘  └────────────────┘  │ │  │
│  │  │                                                         │ │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │ │  │
│  │  │  │GitHubAuth    │  │TelegramAuth  │  │ SmsService  │ │ │  │
│  │  │  │Service       │  │Service       │  │             │ │ │  │
│  │  │  └──────────────┘  └──────────────┘  └─────────────┘ │ │  │
│  │  └─────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                    │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    Data Layer (TypeORM)                     │  │
│  ├────────────────────────────────────────────────────────────┤  │
│  │                                                              │  │
│  │  ┌──────────┐  ┌──────────────┐  ┌──────────────────────┐  │  │
│  │  │   User   │  │ RefreshToken │  │   TwoFactorCode      │  │  │
│  │  ├──────────┤  ├──────────────┤  ├──────────────────────┤  │  │
│  │  │ id       │  │ id           │  │ id                   │  │  │
│  │  │ email    │  │ token        │  │ code                 │  │  │
│  │  │ password │  │ userId       │  │ userId               │  │  │
│  │  │ phone    │  │ userAgent    │  │ type (EMAIL/TELEGRAM)│  │  │
│  │  │ githubId │  │ ipAddress    │  │ status               │  │  │
│  │  │ ...      │  │ expiresAt    │  │ verifiedAt           │  │  │
│  │  │ mfaSettings││ isRevoked    │  │ expiresAt            │  │  │
│  │  └──────────┘  └──────────────┘  └──────────────────────┘  │  │
│  │                                                              │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐  │  │
│  │  │  AuditLog    │  │   Settings   │  │   Role/Perms    │  │  │
│  │  ├──────────────┤  ├──────────────┤  ├─────────────────┤  │  │
│  │  │ id           │  │ key          │  │ ...             │  │  │
│  │  │ userId       │  │ value        │  │                 │  │  │
│  │  │ action       │  │ description  │  │                 │  │  │
│  │  │ service      │  │              │  │                 │  │  │
│  │  │ ipAddress    │  │ ✨ NEW:      │  │                 │  │  │
│  │  │ userAgent    │  │ auth_flow_   │  │                 │  │  │
│  │  │ createdAt    │  │ config       │  │                 │  │  │
│  │  └──────────────┘  └──────────────┘  └─────────────────┘  │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                 │                                 │
└─────────────────────────────────┼─────────────────────────────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │  PostgreSQL DB  │
                         └─────────────────┘
```

---

## 🔄 Поток данных: Настройка Auth Flow (Админ)

```
┌──────────────┐
│ Super Admin  │
└──────┬───────┘
       │
       │ 1. Открывает AuthFlowBuilderPage
       ▼
┌─────────────────────────────────────┐
│   AuthFlowBuilderPage               │
│                                     │
│   GET /admin/auth-flow              │
└───────────┬─────────────────────────┘
            │
            │ 2. Загрузка конфигурации
            ▼
    ┌───────────────┐
    │ AdminController│
    │ GET auth-flow  │
    └───────┬────────┘
            │
            │ 3. Получить из Settings
            ▼
    ┌───────────────┐
    │SettingsService │
    │ getSetting()   │
    └───────┬────────┘
            │
            │ 4. Вернуть JSON
            ▼
    ┌───────────────────────┐
    │ { login: [...],       │
    │   registration: [...],│
    │   factors: [...] }    │
    └───────────┬───────────┘
            │
            │ 5. Отобразить в UI (Drag & Drop)
            ▼
┌─────────────────────────────────────┐
│   Админ изменяет порядок методов    │
│   через Drag & Drop                 │
└───────────┬─────────────────────────┘
            │
            │ 6. Автосохранение (debounce 1s)
            ▼
    ┌───────────────┐
    │ PUT /admin/   │
    │   auth-flow   │
    └───────┬────────┘
            │
            │ 7. Сохранить в Settings
            ▼
    ┌───────────────┐
    │SettingsService │
    │ setSetting()   │
    └───────┬────────┘
            │
            │ 8. Обновить auth_flow_config
            ▼
    ┌───────────────┐
    │ PostgreSQL DB │
    └───────────────┘
```

---

## 🔐 Поток данных: Логин с Auth Flow

```
┌──────────────┐
│   User       │
└──────┬───────┘
       │
       │ 1. Открывает LoginPage
       ▼
┌─────────────────────────────────────┐
│   LoginPage                         │
│                                     │
│   GET /auth/flow (публичный)        │
└───────────┬─────────────────────────┘
            │
            │ 2. Загрузка Auth Flow конфигурации
            ▼
    ┌───────────────┐
    │ AuthController │
    │ GET /auth/flow │
    └───────┬────────┘
            │
            │ 3. Получить конфигурацию
            ▼
    ┌───────────────────────┐
    │ { login: [            │
    │   { id: 'phone-email',│
    │     order: 1 },       │
    │   { id: 'password',   │
    │     order: 2 }        │
    │ ]}                    │
    └───────────┬───────────┘
            │
            │ 4. Отобразить первый шаг (phone-email)
            ▼
┌─────────────────────────────────────┐
│   Пользователь вводит email        │
└───────────┬─────────────────────────┘
            │
            │ 5. POST /auth/login (step 1)
            ▼
    ┌───────────────┐
    │ AuthService    │
    │ validateUser() │
    └───────┬────────┘
            │
            │ 6. Email найден, переход к шагу 2
            ▼
┌─────────────────────────────────────┐
│   Отобразить второй шаг (password)  │
└───────────┬─────────────────────────┘
            │
            │ 7. Пользователь вводит пароль
            ▼
    ┌───────────────┐
    │ AuthService    │
    │ login()        │
    └───────┬────────┘
            │
            │ 8. Проверить пароль
            ▼
    ┌───────────────┐
    │ bcrypt.compare│
    └───────┬────────┘
            │
            │ 9. Проверить nFA (если включен)
            ▼
    ┌───────────────┐
    │ NfaService     │
    │ sendCodes()    │
    └───────┬────────┘
            │
            │ 10. Отправить коды (Email, Telegram, GitHub)
            ▼
┌─────────────────────────────────────┐
│   Отобразить окно ввода кодов       │
└───────────┬─────────────────────────┘
            │
            │ 11. Пользователь вводит коды
            ▼
    ┌───────────────┐
    │ NfaService     │
    │ verifyMethod() │
    └───────┬────────┘
            │
            │ 12. Все коды верны?
            ▼
    ┌───────────────┐
    │ AuthService    │
    │ generateTokens│
    └───────┬────────┘
            │
            │ 13. Создать Access + Refresh Token
            ▼
    ┌───────────────────────┐
    │ { accessToken,        │
    │   refreshToken,       │
    │   user: {...} }       │
    └───────────┬───────────┘
            │
            │ 14. Залогировать событие
            ▼
    ┌───────────────┐
    │ AuditService   │
    │ log('login')   │
    └───────┬────────┘
            │
            │ 15. Вернуть токены клиенту
            ▼
┌─────────────────────────────────────┐
│   Сохранить в localStorage/cookies  │
│   Перенаправить на Dashboard        │
└─────────────────────────────────────┘
```

---

## 🛡️ Поток данных: Управление безопасностью (Пользователь)

### 1. Просмотр устройств

```
┌──────────────┐
│   User       │
└──────┬───────┘
       │
       │ Открывает SecurityDevicesPage
       ▼
┌─────────────────────────────────────┐
│   SecurityDevicesPage               │
│                                     │
│   GET /security/devices             │
└───────────┬─────────────────────────┘
            │
            ▼
    ┌───────────────────┐
    │SecurityController │
    │ GET /devices      │
    └───────┬───────────┘
            │
            ▼
    ┌───────────────────┐
    │SecurityService    │
    │ getDevices()      │
    └───────┬───────────┘
            │
            │ Получить все RefreshToken где isRevoked = false
            ▼
    ┌───────────────────┐
    │ RefreshToken Repo │
    │ find({ userId })  │
    └───────┬───────────┘
            │
            │ Парсить userAgent
            ▼
    ┌───────────────────────────┐
    │ [                         │
    │   {                       │
    │     id: "token-uuid",     │
    │     device: "Windows PC", │
    │     browser: "Chrome",    │
    │     ip: "192.168.1.1",    │
    │     lastActivity: "..."   │
    │   }                       │
    │ ]                         │
    └───────────┬───────────────┘
            │
            │ Отобразить список
            ▼
┌─────────────────────────────────────┐
│   UI: Список устройств с кнопкой    │
│   "Удалить" для каждого             │
└─────────────────────────────────────┘
```

### 2. Выход со всех устройств

```
┌──────────────┐
│   User       │
└──────┬───────┘
       │
       │ Нажимает "Выйти везде"
       ▼
┌─────────────────────────────────────┐
│   Модалка подтверждения             │
│   "Вы будете разлогинены везде"     │
└───────────┬─────────────────────────┘
            │
            │ Подтверждает
            ▼
    ┌───────────────────┐
    │ POST /security/   │
    │   logout-all      │
    └───────┬───────────┘
            │
            ▼
    ┌───────────────────┐
    │SecurityService    │
    │ logoutFromAll()   │
    └───────┬───────────┘
            │
            │ Установить isRevoked = true для всех токенов
            ▼
    ┌───────────────────┐
    │ RefreshToken Repo │
    │ update({ userId })│
    └───────┬───────────┘
            │
            │ Залогировать событие
            ▼
    ┌───────────────────┐
    │ AuditService      │
    │ log('logout-all') │
    └───────┬───────────┘
            │
            │ Вернуть success
            ▼
┌─────────────────────────────────────┐
│   Перенаправить на /login           │
└─────────────────────────────────────┘
```

### 3. Добавление дополнительного фактора

```
┌──────────────┐
│   User       │
└──────┬───────┘
       │
       │ Открывает модалку "Способы входа"
       ▼
┌─────────────────────────────────────┐
│   AuthMethodsModal                  │
│                                     │
│   GET /auth/user-flow-settings      │
└───────────┬─────────────────────────┘
            │
            │ Получить обязательные + дополнительные факторы
            ▼
    ┌───────────────────────────────┐
    │ { mandatory: {                │
    │     login: [...],             │
    │     factors: ['EMAIL']        │
    │   },                          │
    │   user: {                     │
    │     additionalFactors: []     │
    │   }                           │
    │ }                             │
    └───────────┬───────────────────┘
            │
            │ Отобразить:
            │ - Обязательные (readonly)
            │ - Дополнительные (можно добавить/удалить)
            ▼
┌─────────────────────────────────────┐
│   Пользователь нажимает "Добавить"  │
│   для TELEGRAM фактора              │
└───────────┬─────────────────────────┘
            │
            │ POST /auth/user-additional-factors
            │ { method: "PHONE_TELEGRAM" }
            ▼
    ┌───────────────────┐
    │ AuthController    │
    │ addAdditionalFactor│
    └───────┬───────────┘
            │
            │ Проверить, что метод доступен
            ▼
    ┌───────────────────┐
    │ User.available    │
    │ AuthMethods       │
    └───────┬───────────┘
            │
            │ Добавить в mfaSettings.methods
            ▼
    ┌───────────────────┐
    │ UsersService      │
    │ update()          │
    └───────┬───────────┘
            │
            │ Обновить User в БД
            ▼
    ┌───────────────────┐
    │ PostgreSQL DB     │
    └───────┬───────────┘
            │
            │ Вернуть success
            ▼
┌─────────────────────────────────────┐
│   Обновить UI: TELEGRAM добавлен    │
│   Теперь при логине будет запрашивать│
│   код и для Telegram                │
└─────────────────────────────────────┘
```

---

## 🗄️ Схема базы данных

```sql
┌─────────────────────────────────────────────────────────────────┐
│                            Users                                │
├─────────────────────────────────────────────────────────────────┤
│ id                    UUID         PRIMARY KEY                  │
│ email                 VARCHAR(255) UNIQUE                       │
│ passwordHash          VARCHAR(255)                              │
│ firstName             VARCHAR(100)                              │
│ lastName              VARCHAR(100)                              │
│ phone                 VARCHAR(20)                               │
│ primaryAuthMethod     ENUM (EMAIL, PHONE_TELEGRAM, GITHUB, ...) │
│ emailAuthType         ENUM (password, code)                     │
│ hasEmailCode          BOOLEAN                                   │
│ availableAuthMethods  JSONB                                     │
│ mfaSettings           JSONB {                                   │
│                         enabled: boolean,                       │
│                         methods: string[],                      │
│                         backupCodes: string[],                  │
│                         requiredMethods: number                 │
│                       }                                         │
│ githubId              VARCHAR(255)                              │
│ githubUsername        VARCHAR(255)                              │
│ emailVerified         BOOLEAN                                   │
│ phoneVerified         BOOLEAN                                   │
│ githubVerified        BOOLEAN                                   │
│ createdAt             TIMESTAMP                                 │
│ updatedAt             TIMESTAMP                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ 1:N
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        RefreshTokens                            │
├─────────────────────────────────────────────────────────────────┤
│ id                    UUID         PRIMARY KEY                  │
│ token                 VARCHAR(255) UNIQUE                       │
│ userId                UUID         FOREIGN KEY → Users.id       │
│ expiresAt             TIMESTAMP                                 │
│ isRevoked             BOOLEAN      DEFAULT false                │
│ userAgent             VARCHAR(500) -- Browser, OS, Device       │
│ ipAddress             VARCHAR(50)  -- IP адрес                  │
│ createdAt             TIMESTAMP                                 │
│ updatedAt             TIMESTAMP                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        TwoFactorCodes                           │
├─────────────────────────────────────────────────────────────────┤
│ id                    UUID         PRIMARY KEY                  │
│ code                  VARCHAR(10)                               │
│ userId                UUID         FOREIGN KEY → Users.id       │
│ type                  ENUM (EMAIL, TELEGRAM, GITHUB, SMS)       │
│ status                ENUM (PENDING, VERIFIED, EXPIRED)         │
│ verifiedAt            TIMESTAMP                                 │
│ expiresAt             TIMESTAMP                                 │
│ createdAt             TIMESTAMP                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          AuditLogs                              │
├─────────────────────────────────────────────────────────────────┤
│ id                    UUID         PRIMARY KEY                  │
│ userId                UUID         FOREIGN KEY → Users.id       │
│ service               VARCHAR(50)  -- Auth, Security, etc       │
│ action                VARCHAR(100) -- login, logout, change-pwd │
│ resource              VARCHAR(100)                              │
│ requestData           JSONB                                     │
│ statusCode            INTEGER                                   │
│ ipAddress             VARCHAR(50)                               │
│ userAgent             VARCHAR(500)                              │
│ createdAt             TIMESTAMP                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          Settings                               │
├─────────────────────────────────────────────────────────────────┤
│ id                    UUID         PRIMARY KEY                  │
│ key                   VARCHAR(255) UNIQUE                       │
│ value                 TEXT         -- JSON string               │
│ description           TEXT                                      │
│ createdAt             TIMESTAMP                                 │
│ updatedAt             TIMESTAMP                                 │
│                                                                 │
│ ✨ Пример: key = "auth_flow_config"                            │
│           value = '{"login": [...], "registration": [...],     │
│                      "factors": [...]}'                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔐 Модель безопасности

### Уровни защиты:

```
┌──────────────────────────────────────────────────────────────────┐
│                      Уровень 1: Базовый                          │
├──────────────────────────────────────────────────────────────────┤
│ • Email + Пароль                                                 │
│ • Хеширование паролей (bcrypt, salt rounds = 12)                │
│ • JWT токены (Access 15 мин + Refresh 30 дней)                  │
│ • HTTPS на production                                            │
└──────────────────────────────────────────────────────────────────┘
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│                  Уровень 2: Многофакторная (nFA)                │
├──────────────────────────────────────────────────────────────────┤
│ • Обязательные факторы (установлены админом)                    │
│ • Дополнительные факторы (выбирает пользователь)                │
│ • Методы: Email, Telegram, GitHub, SMS                          │
│ • Коды действительны 10 минут                                   │
│ • Защита от brute-force (rate limiting)                         │
└──────────────────────────────────────────────────────────────────┘
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│                 Уровень 3: Контроль сессий                      │
├──────────────────────────────────────────────────────────────────┤
│ • Отслеживание устройств (userAgent + IP)                       │
│ • Удаление сессий                                                │
│ • Выход со всех устройств                                        │
│ • Аудит логирование всех действий                               │
│ • Геолокация (опционально)                                      │
└──────────────────────────────────────────────────────────────────┘
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│                  Уровень 4: Восстановление                      │
├──────────────────────────────────────────────────────────────────┤
│ • Множественные способы восстановления                          │
│ • Верификация контактов                                          │
│ • Email уведомления о важных событиях                           │
│ • Backup коды (опционально)                                     │
└──────────────────────────────────────────────────────────────────┘
```

---

## 🚀 Технологический стек

```
┌─────────────────────────────────────────┐
│            Frontend                     │
├─────────────────────────────────────────┤
│ • React 18                              │
│ • TypeScript 5                          │
│ • React Router 6                        │
│ • TanStack Query (React Query)          │
│ • i18next (Многоязычность)              │
│ • Tailwind CSS                          │
│ • Vite (Build tool)                     │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│            Backend                      │
├─────────────────────────────────────────┤
│ • NestJS 10                             │
│ • TypeORM                               │
│ • PostgreSQL 14+                        │
│ • JWT (jsonwebtoken)                    │
│ • bcrypt (хеширование)                  │
│ • Passport.js (OAuth)                   │
│ • nodemailer (Email)                    │
│ • Telegram Bot API                      │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│            DevOps                       │
├─────────────────────────────────────────┤
│ • Docker + Docker Compose               │
│ • PostgreSQL Container                  │
│ • Backend Container (NestJS)            │
│ • Frontend (local dev)                  │
│ • Nginx (reverse proxy)                 │
└─────────────────────────────────────────┘
```

---

## 📈 Масштабирование

### Горизонтальное масштабирование:

```
                    ┌─────────────┐
                    │ Load Balancer│
                    └──────┬──────┘
                           │
          ┌────────────────┼────────────────┐
          ▼                ▼                ▼
    ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ Backend  │     │ Backend  │     │ Backend  │
    │ Instance │     │ Instance │     │ Instance │
    │    1     │     │    2     │     │    3     │
    └────┬─────┘     └────┬─────┘     └────┬─────┘
         │                │                │
         └────────────────┼────────────────┘
                          ▼
                 ┌─────────────────┐
                 │  PostgreSQL     │
                 │  Master-Slave   │
                 └─────────────────┘
                          │
                 ┌────────┴────────┐
                 ▼                 ▼
          ┌──────────┐       ┌──────────┐
          │  Redis   │       │  Redis   │
          │  Cache   │       │ Sessions │
          └──────────┘       └──────────┘
```

### Кэширование:

- Auth Flow конфигурация (TTL: 5 минут)
- Список устройств пользователя (TTL: 1 минута)
- User profile (TTL: 5 минут)

---

## ⚡ Производительность

### Оптимизации:

1. **Database Indexes:**
   ```sql
   CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(userId);
   CREATE INDEX idx_refresh_tokens_token ON refresh_tokens(token);
   CREATE INDEX idx_audit_logs_user_id ON audit_logs(userId);
   CREATE INDEX idx_audit_logs_created_at ON audit_logs(createdAt);
   ```

2. **Query Optimization:**
   - Eager loading для связанных entity
   - Pagination для больших списков
   - Использование connection pooling

3. **Frontend:**
   - Code splitting по роутам
   - Lazy loading компонентов
   - Image optimization
   - Debounce для автосохранения

---

## 🎨 Design Patterns

### Backend:

- **Repository Pattern** - доступ к данным через TypeORM repositories
- **Service Layer** - бизнес-логика в сервисах
- **Guard Pattern** - проверка аутентификации и авторизации
- **Decorator Pattern** - кастомные декораторы (@CurrentUser, @RequireRoles)
- **Observer Pattern** - EventBusService для событий

### Frontend:

- **Container/Presentational** - разделение логики и UI
- **Composition** - переиспользуемые компоненты
- **Hooks Pattern** - кастомные хуки (useModal, useDebounce)
- **Provider Pattern** - контексты для глобального состояния
- **Atomic Design** - структура Design System

---

## 📚 Документация

- **[AUTH_SECURITY_SYSTEM_ROADMAP.md](./AUTH_SECURITY_SYSTEM_ROADMAP.md)** - Детальный план с примерами кода
- **[AUTH_SECURITY_QUICK_PLAN.md](./AUTH_SECURITY_QUICK_PLAN.md)** - Краткий обзор и временная оценка
- **[ARCHITECTURE_DIAGRAM.md](./ARCHITECTURE_DIAGRAM.md)** - Архитектурные диаграммы (этот документ)

---

**Создано:** [Дата]  
**Версия:** 1.0  
**Статус:** Ready for Implementation ✅

