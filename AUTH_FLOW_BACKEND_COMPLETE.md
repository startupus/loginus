# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ß–ê–°–¢–¨: Auth Flow Backend - –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê

## üìä –°—Ç–∞—Ç—É—Å: –ó–ê–í–ï–†–®–ï–ù–û

### ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

#### 1. AuthFlowService (`backend/src/auth/services/auth-flow.service.ts`)
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- `getLoginFlow()` - –ø–æ–ª—É—á–∏—Ç—å —à–∞–≥–∏ –≤—Ö–æ–¥–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `getRegistrationFlow()` - –ø–æ–ª—É—á–∏—Ç—å —à–∞–≥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `getFactorsFlow()` - –ø–æ–ª—É—á–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã 2FA
- `getNextStep()` - –ø–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–≥–æ
- `isLastStep()` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —à–∞–≥ –ø–æ—Å–ª–µ–¥–Ω–∏–º
- `validateStepData()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —à–∞–≥–∞
- `getPrimaryStep()` - –ø–æ–ª—É—á–∏—Ç—å primary —à–∞–≥
- `getRequiredRegistrationFields()` - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —à–∞–≥–∏:**
- `phone-email` - –≤–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ email
- `password` - –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è
- `sms-code` / `email-code` - –≤–≤–æ–¥ –∫–æ–¥–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `name`, `surname`, `birthdate`, `gender` - –ø–æ–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- OAuth –º–µ—Ç–æ–¥—ã (`github`, `telegram`, etc.)

---

#### 2. DTO –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (`backend/src/auth/dto/auth-step.dto.ts`)
**–ö–ª–∞—Å—Å—ã:**
- `LoginStepDto` - –¥–ª—è —à–∞–≥–æ–≤ –≤—Ö–æ–¥–∞
- `RegisterStepDto` - –¥–ª—è —à–∞–≥–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `AuthStepResponseDto` - –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

**–ü–æ–ª—è:**
- `stepId` - ID —à–∞–≥–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `sessionId` - ID —Å–µ—Å—Å–∏–∏ –¥–ª—è —Å–≤—è–∑–∏ —à–∞–≥–æ–≤
- `data` - –¥–∞–Ω–Ω—ã–µ —à–∞–≥–∞ (–∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–∏–ø–∞)
- `nextStep` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
- `completed` - —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- `tempData` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞

---

#### 3. –ù–æ–≤—ã–µ Endpoints –≤ AuthController

**POST `/auth/login/step`** - –ü–æ—à–∞–≥–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–≤—Ö–æ–¥)
```typescript
Request: {
  stepId: 'phone-email' | 'password' | 'sms-code' | ...,
  sessionId?: string,
  data: {
    // –ó–∞–≤–∏—Å–∏—Ç –æ—Ç stepId
    login?: string,      // –¥–ª—è phone-email
    password?: string,   // –¥–ª—è password
    code?: string,       // –¥–ª—è sms-code/email-code
    userId?: string      // –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
  }
}

Response: {
  success: boolean,
  sessionId?: string,
  nextStep?: {
    id: string,
    name: string,
    type: string,
    requiresVerification: boolean
  },
  completed: boolean,
  accessToken?: string,  // –µ—Å–ª–∏ completed
  refreshToken?: string, // –µ—Å–ª–∏ completed
  user?: any,           // –µ—Å–ª–∏ completed
  tempData?: any        // –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —à–∞–≥ –ø–æ—Å–ª–µ–¥–Ω–∏–º
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —à–∞–≥–∞:
   - `phone-email`: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `password`: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ AuthService
   - `sms-code`/`email-code`: –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞
4. –ï—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥ ‚Üí –≤–æ–∑–≤—Ä–∞—Ç `nextStep`
5. –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥ ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤

---

**POST `/auth/register/step`** - –ü–æ—à–∞–≥–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```typescript
Request: {
  stepId: string,
  sessionId?: string,
  data: {
    sessionData?: any,  // –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤
    ...currentStepData  // –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
  }
}

Response: –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ loginStep
```

**–õ–æ–≥–∏–∫–∞:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —à–∞–≥–∞
2. –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ `sessionData`
3. –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
   - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `authService.register()`
   - –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–∫–µ–Ω–æ–≤
4. –ò–Ω–∞—á–µ ‚Üí –≤–æ–∑–≤—Ä–∞—Ç `nextStep`

---

**GET `/auth/login/first-step`** - –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–≥ –≤—Ö–æ–¥–∞
```typescript
Response: {
  success: true,
  data: {
    step: AuthFlowStep,
    totalSteps: number
  }
}
```

**GET `/auth/register/first-step`** - –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
```typescript
Response: {
  success: true,
  data: {
    step: AuthFlowStep,
    totalSteps: number,
    requiredFields: string[]
  }
}
```

---

#### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Auth Module
- ‚úÖ AuthFlowService –¥–æ–±–∞–≤–ª–µ–Ω –≤ providers
- ‚úÖ AuthFlowService —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
- ‚úÖ –ò–º–ø–æ—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã

---

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

### –ü—Ä–∏–º–µ—Ä: –í—Ö–æ–¥ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π [phone-email ‚Üí password]

**–®–∞–≥ 1:** Frontend –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–π —à–∞–≥
```http
GET /auth/login/first-step
```
```json
{
  "step": {
    "id": "phone-email",
    "name": "Phone or Email",
    "type": "primary"
  },
  "totalSteps": 2
}
```

**–®–∞–≥ 2:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç email, Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç
```http
POST /auth/login/step
{
  "stepId": "phone-email",
  "data": { "login": "user@example.com" }
}
```
```json
{
  "success": true,
  "sessionId": "session-123",
  "nextStep": {
    "id": "password",
    "name": "Password",
    "type": "alternative"
  },
  "completed": false,
  "tempData": { "userId": "user-uuid" }
}
```

**–®–∞–≥ 3:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø–∞—Ä–æ–ª—å
```http
POST /auth/login/step
{
  "stepId": "password",
  "sessionId": "session-123",
  "data": {
    "userId": "user-uuid",
    "password": "SecurePass123"
  }
}
```
```json
{
  "success": true,
  "completed": true,
  "accessToken": "jwt-token",
  "refreshToken": "refresh-token",
  "user": { ... }
}
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** - –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫ —à–∞–≥–æ–≤ –≤ AuthFlowBuilder
2. ‚úÖ **–ü–æ—à–∞–≥–æ–≤–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π —à–∞–≥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
3. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
4. ‚úÖ **–°–æ—Å—Ç–æ—è–Ω–∏–µ** - sessionId —Å–≤—è–∑—ã–≤–∞–µ—Ç —à–∞–≥–∏ –º–µ–∂–¥—É —Å–æ–±–æ–π
5. ‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —à–∞–≥–æ–≤
6. ‚úÖ **OAuth —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å OAuth flow
7. ‚úÖ **2FA/nFA** - –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π MFA —Å–∏—Å—Ç–µ–º–æ–π

---

## üìù –ß—Ç–æ –µ—â–µ –Ω—É–∂–Ω–æ:

### Frontend (—Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø):
1. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å AuthPage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `/auth/login/step`
2. ‚è≥ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç StepRenderer - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–µ–Ω–¥–µ—Ä —à–∞–≥–∞
3. ‚è≥ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (sessionId, tempData)
4. ‚è≥ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
5. ‚è≥ –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- ‚è≥ Redis/Session store –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è `sessionData` (—Å–µ–π—á–∞—Å –≤ –ø–∞–º—è—Ç–∏)
- ‚è≥ Rate limiting –¥–ª—è endpoints
- ‚è≥ –¢–µ—Å—Ç—ã –¥–ª—è AuthFlowService –∏ endpoints

---

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: 100%

**Backend –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤!** –í—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç, –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞, –ø–æ—à–∞–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç.

–¢–µ–ø–µ—Ä—å Frontend –º–æ–∂–µ—Ç:
1. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–≥ (`/auth/login/first-step`)
2. –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É –¥–ª—è —ç—Ç–æ–≥–æ —à–∞–≥–∞
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (`/auth/login/step`)
4. –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –∏–ª–∏ —Ç–æ–∫–µ–Ω—ã
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** [–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞]  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

