# Отчет о проверке фичей через браузер

## Дата проверки: 2025-01-27

## Проверенные фичи

### 1. ✅ Алгоритм авторизации (частично работает)

**Статус:** Страница загружается, порядок шагов отображается правильно

**Что работает:**
- Страница `/ru/admin/auth-flow` загружается корректно
- Разделы "Окно входа", "Регистрация", "Факторы авторизации" отображаются
- Порядок шагов отображается правильно (1, 2, 3, 4 для регистрации)
- Сохранение конфигурации работает (PUT /admin/auth-flow успешно)

**Проблемы:**
- ⚠️ Множественные предупреждения об отсутствующих иконках для методов:
  - `apple`, `phone-email`, `vk`, `google`, `microsoft`, `biometric`, `sms`
  - `birthdate`, `surname`, `name`, `inn` (для полей регистрации)
  - `login-window` (для факторов)
- ⚠️ Не проверено, применяется ли конфигурация к реальным формам входа/регистрации

---

### 2. ❌ Настройки меню (не работает)

**Статус:** Чекбоксы не кликабельны, сохранение не работает

**Что работает:**
- Страница `/ru/admin/menu-settings` загружается
- Список пунктов меню отображается
- Чекбоксы визуально присутствуют

**Проблемы:**
- ❌ **КРИТИЧНО:** Чекбоксы перекрыты другими элементами (`<div class="relative">` intercepts pointer events)
- ❌ **КРИТИЧНО:** При попытке сохранить изменения получаем `403 Forbidden` (PUT /admin/menu-settings)
- ❌ В личном кабинете все пункты меню отображаются, включая те, которые должны быть отключены (фильтрация не работает из-за невозможности отключить пункт)

**Ошибка в консоли:**
```
[ERROR] [API] PUT /admin/menu-settings: ERROR after 59.40ms Request failed with status code 403
```

---

### 3. ❌ Создание пользователя (не работает)

**Статус:** Кнопка есть, но модальное окно не открывается

**Что работает:**
- Страница `/ru/admin/users` загружается
- Кнопка "Добавить" присутствует и кликабельна
- Таблица пользователей отображается

**Проблемы:**
- ❌ **КРИТИЧНО:** При клике на кнопку "Добавить" модальное окно не открывается
- ❌ Не проверено создание компании (аналогичная проблема ожидается)

---

### 4. ❌ Приглашение в семейную группу (не работает)

**Статус:** Кнопка есть, но модальное окно не открывается

**Что работает:**
- Страница `/ru/dashboard` загружается
- Раздел "Семья" отображается
- Кнопка "Добавить участника" присутствует и кликабельна

**Проблемы:**
- ❌ **КРИТИЧНО:** При клике на кнопку "Добавить участника" модальное окно не открывается
- ❌ Не проверена генерация ссылки приглашения
- ❌ Не проверена страница `/ru/invitation` для обработки приглашений

---

## План исправления

### Приоритет 1: Критические проблемы

#### 1.1. Исправить кликабельность чекбоксов в настройках меню

**Проблема:** Чекбоксы перекрыты обёрткой `<div class="relative">`

**Решение:**
- В `frontend/src/pages/admin/MenuSettingsPage.tsx` в компоненте `MenuItem`:
  - Убрать `pointer-events: none` с обёртки Switch
  - Или добавить `onClick` на родительский `div` с `ml-auto`, который будет вызывать `onToggle`
  - Или использовать `label` для чекбокса вместо скрытого `input`

**Файлы для изменения:**
- `frontend/src/pages/admin/MenuSettingsPage.tsx` (компонент `MenuItem`, строка ~147-152)

---

#### 1.2. Исправить 403 Forbidden при сохранении настроек меню

**Проблема:** API возвращает 403 при попытке сохранить настройки меню

**Решение:**
- Проверить права доступа в `backend/src/admin/admin.controller.ts` для эндпоинта `PUT /admin/menu-settings`
- Убедиться, что `@RequireRoles('super_admin')` корректно работает
- Проверить, что debug-утилита `window.adminDebug.setRole('super_admin')` устанавливает роль не только на фронтенде, но и на бэкенде (через токен/cookie)

**Файлы для проверки:**
- `backend/src/admin/admin.controller.ts` (метод `updateMenuSettings`)
- `frontend/src/utils/adminDebug.ts` (утилита для установки роли)

---

#### 1.3. Исправить открытие модальных окон (создание пользователя/компании/приглашение)

**Проблема:** Модальные окна не открываются при клике на кнопки

**Решение:**
- Проверить, что модальные окна загружаются (lazy loading)
- Проверить состояние `isOpen` в компонентах модальных окон
- Проверить обработчики `onClick` на кнопках "Добавить"
- Проверить консоль браузера на наличие ошибок JavaScript

**Файлы для проверки:**
- `frontend/src/pages/admin/UsersPage.tsx` (кнопка "Добавить")
- `frontend/src/pages/admin/CompaniesPage.tsx` (кнопка "Добавить")
- `frontend/src/pages/DashboardPage.tsx` (кнопка "Добавить участника")
- `frontend/src/components/Modals/InviteFamilyMemberModal.tsx`
- `frontend/src/components/Admin/UserEditModal.tsx`
- `frontend/src/components/Admin/CompanyEditModal.tsx`

---

### Приоритет 2: Предупреждения и улучшения

#### 2.1. Добавить недостающие иконки для методов авторизации

**Проблема:** Множественные предупреждения об отсутствующих иконках

**Решение:**
- Добавить иконки в `frontend/src/design-system/primitives/Icon.tsx` для:
  - `apple`, `phone-email`, `vk`, `google`, `microsoft`, `biometric`, `sms`
  - `birthdate`, `surname`, `name`, `inn`
  - `login-window`
- Или обновить функцию `getAuthMethodIcon` для использования fallback-иконок

**Файлы для изменения:**
- `frontend/src/design-system/primitives/Icon.tsx`
- `frontend/src/components/Admin/MethodColumn.tsx` (функция `getAuthMethodIcon`)

---

#### 2.2. Проверить применение алгоритма авторизации к формам входа/регистрации

**Проблема:** Не проверено, применяется ли конфигурация к реальным формам

**Решение:**
- Проверить, что `/ru/auth` использует `auth_flow_config.login` для отображения методов входа
- Проверить, что `/ru/onboarding` использует `auth_flow_config.registration` для отображения полей регистрации
- Проверить, что порядок методов соответствует конфигурации

**Файлы для проверки:**
- `frontend/src/pages/auth/AuthPage.tsx`
- `frontend/src/pages/auth/OnboardingPage.tsx`

---

## Итоговая статистика

- ✅ **Работает:** 1 фича (алгоритм авторизации - частично)
- ❌ **Не работает:** 3 фичи (настройки меню, создание пользователя/компании, приглашение в семью)
- ⚠️ **Требует доработки:** 1 фича (алгоритм авторизации - иконки и проверка применения)

## Рекомендации

1. **Немедленно исправить:** Проблемы с кликабельностью чекбоксов и открытием модальных окон
2. **Проверить права доступа:** Убедиться, что debug-утилита корректно устанавливает роль на бэкенде
3. **Добавить недостающие иконки:** Устранить предупреждения в консоли
4. **Провести полное тестирование:** После исправлений проверить все фичи в браузере повторно

