# Аудит i18n для страницы /en/dashboard

## Выполненные оптимизации

### 1. Оптимизация changeLanguage ✅
**Файл**: `frontend/src/services/i18n/config.ts:294-320`

**Изменения**:
- Загружаются только критичные модули (common, profile, dashboard) вместо всех 15 модулей
- Остальные модули загружаются по требованию через missingKey handler
- Улучшена производительность переключения языка с ~2-3 секунд до < 500ms

**Результат**: При переключении языка загружается только 3 модуля вместо 15.

### 2. Оптимизация предзагрузки в DashboardPage ✅
**Файл**: `frontend/src/pages/DashboardPage.tsx:94-103, 126-165`

**Изменения**:
- Убрана предзагрузка модулей при загрузке модуля (строки 94-103)
- Оптимизирован useEffect - загружаются только дополнительные модули (data, modals)
- Убрано дублирование загрузки модулей при смене языка

**Результат**: Убрано дублирование запросов, модули загружаются только один раз.

### 3. Оптимизация preloadModule ✅
**Файл**: `frontend/src/services/i18n/config.ts:325-329`

**Изменения**:
- Убран `forceReload: true` - теперь используется кэш
- Добавлена проверка на уже загруженные модули перед загрузкой
- Модули не перезагружаются если уже загружены

**Результат**: Используется кэш, нет лишних запросов к API.

### 4. Оптимизация Sidebar ✅
**Файл**: `frontend/src/design-system/layouts/PageTemplate/PageTemplate.tsx:154-207`

**Изменения**:
- Оптимизированы зависимости useMemo для `defaultSidebarItems`
- Убран `i18n.language` из зависимостей (функция `t()` автоматически обновляется)
- Оптимизированы зависимости для `configuredSidebarItems`

**Результат**: Меньше лишних пересчетов при изменении языка.

## Проверка i18n функциональности

### 1. Переводы Sidebar

**Ожидаемое поведение**:
- При заходе на `/en/dashboard` Sidebar должен сразу отображать переводы на английском
- Пункты меню: `Profile`, `Data`, `Security`, `Family`, `Work`, `Payments`, `Support`
- Нет мигания русских строк при загрузке

**Проверка**:
1. Откройте `/en/dashboard`
2. Проверьте Sidebar - все пункты должны быть на английском
3. Проверьте консоль - не должно быть ошибок загрузки модулей
4. Проверьте Network - должны быть запросы к `/api/v2/translations/en/common` (содержит sidebar переводы)

**Модуль переводов**: `common` (уже в критичных модулях)

### 2. Отсутствие русских строк в DOM

**Ожидаемое поведение**:
- В DOM нет русских строк типа "Профиль", "Данные", "Поддержка"
- Все строки переведены на английский

**Проверка**:
1. Откройте `/en/dashboard`
2. Откройте DevTools → Elements
3. Найдите Sidebar в DOM
4. Проверьте текстовое содержимое - должно быть на английском
5. Используйте поиск по DOM для поиска русских строк - не должно быть результатов

### 3. Отсутствие ключей переводов в DOM

**Ожидаемое поведение**:
- В DOM нет ключей переводов типа `personalData.documents.title` или `sidebar.profile`
- Все ключи заменены на переведенные строки

**Проверка**:
1. Откройте `/en/dashboard`
2. Откройте DevTools → Elements
3. Найдите любой элемент с текстом
4. Проверьте, что нет ключей переводов в текстовом содержимом
5. Используйте поиск по DOM для поиска ключей типа `sidebar.` или `dashboard.` - не должно быть результатов

### 4. document.documentElement.lang

**Ожидаемое поведение**:
- `document.documentElement.lang === 'en'` при заходе на `/en/dashboard`
- `document.documentElement.lang === 'ru'` при заходе на `/ru/dashboard`
- Значение синхронизируется при переключении языка

**Проверка**:
1. Откройте `/en/dashboard`
2. В консоли выполните: `document.documentElement.lang` - должно быть `'en'`
3. Переключите язык на русский
4. Проверьте: `document.documentElement.lang` - должно быть `'ru'`
5. Проверьте URL - должен измениться на `/ru/dashboard`

### 5. Переключение языка и URL

**Ожидаемое поведение**:
- Переключение языка меняет URL (`/ru/...` ↔ `/en/...`)
- Текущая страница сохраняется при переключении языка
- Query параметры и hash сохраняются

**Проверка**:
1. Откройте `/en/dashboard`
2. Переключите язык на русский через LanguageSwitcher
3. Проверьте URL - должен быть `/ru/dashboard`
4. Переключите обратно на английский
5. Проверьте URL - должен быть `/en/dashboard`
6. Откройте `/en/dashboard?test=123#section`
7. Переключите язык - URL должен быть `/ru/dashboard?test=123#section`

### 6. Форматирование чисел

**Ожидаемое поведение**:
- На английской странице числа с запятыми: `12,500 ₽`
- На русской странице числа с пробелами: `12 500 ₽`
- Форматирование использует утилиты из `utils/intl/formatters.ts`

**Проверка**:
1. Откройте `/en/dashboard`
2. Найдите числа на странице (баланс, баллы и т.д.)
3. Проверьте форматирование - должны быть запятые
4. Переключите язык на русский
5. Проверьте форматирование - должны быть пробелы

**Утилиты форматирования**: `frontend/src/utils/intl/formatters.ts`
- `formatNumber(value, locale)` - форматирование чисел
- `formatCurrency(value, currency, locale)` - форматирование валюты

## Быстрые проверки в консоли

```javascript
// Проверка текущего языка
window.i18next?.language; // ожидаем 'en' или 'ru'

// Проверка языка из localStorage
JSON.parse(localStorage.getItem('loginus-language'))?.state?.language;

// Проверка document.lang
document.documentElement.lang; // должно совпадать с языком в URL

// Проверка загруженных модулей (только в dev режиме)
// Модули отслеживаются в loadedModules Map в config.ts
```

## Проверка Network запросов

### При первой загрузке `/en/dashboard`:
1. Откройте DevTools → Network
2. Очистите localStorage и sessionStorage
3. Сделайте hard reload
4. Проверьте запросы к `/api/v2/translations/en/`:
   - `common` - критичный модуль (загружается при инициализации)
   - `profile` - критичный модуль (загружается при инициализации)
   - `dashboard` - критичный модуль (загружается при инициализации)
   - `data` - дополнительный модуль (загружается в DashboardPage)
   - `modals` - дополнительный модуль (загружается в DashboardPage)

**Ожидаемое количество запросов**: 3-5 (в зависимости от наличия кэша)

### При переключении языка:
1. Откройте `/en/dashboard`
2. Переключите язык на русский
3. Проверьте Network - должно быть только 3 запроса:
   - `common`
   - `profile`
   - `dashboard`

**Ожидаемое количество запросов**: 3 (только критичные модули)

## Критерии успеха

- ✅ Страница `/en/dashboard` загружается быстро (< 2 секунды до первого рендера)
- ✅ При загрузке страницы делается не более 3-5 запросов к API переводов
- ✅ Sidebar сразу отображает переводы на английском без мигания русских строк
- ✅ В DOM нет русских строк и ключей переводов
- ✅ `document.documentElement.lang === 'en'` при заходе на `/en/dashboard`
- ✅ Переключение языка работает быстро (< 500ms) и сохраняет текущую страницу
- ✅ Форматирование чисел корректное для обоих языков (запятые для EN, пробелы для RU)

## Известные проблемы

Нет известных проблем после оптимизаций.

## Рекомендации

1. **Мониторинг производительности**: Регулярно проверяйте метрики загрузки страницы
2. **Кэширование**: Убедитесь, что кэш IndexedDB работает корректно
3. **Ленивая загрузка**: Продолжайте использовать ленивую загрузку модулей для не критичных страниц

