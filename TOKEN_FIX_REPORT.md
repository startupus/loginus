# üîç –ù–ê–ô–î–ï–ù–ê –ò –ò–°–ü–†–ê–í–õ–ï–ù–ê –ü–†–û–ë–õ–ï–ú–ê!

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê:

### **–ß—Ç–æ –æ–±–Ω–∞—Ä—É–∂–∏–ª —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä:**
1. ‚úÖ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è (2 + 2 = 4)
3. ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
4. ‚ùå **–ù–û:** –í –ª–æ–≥–µ –≤–∏–¥–Ω–æ "‚ö†Ô∏è –°–æ–±—ã—Ç–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–æ—Ñ–ª–∞–π–Ω)"
5. ‚ùå **–ù–û:** –í Network tab **–ù–ï–¢** –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ `/api/v2/events/emit`
6. ‚ùå **–ù–û:** –í –ë–î **0 —Å–æ–±—ã—Ç–∏–π**

### **–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
**Iframe –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ localStorage —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞** –∏–∑-–∑–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (Same-Origin Policy).

–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω —Ç–∞–∫:
```javascript
const authStore = localStorage.getItem('auth-store'); // ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ iframe!
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: `authToken = null` ‚Üí `backendConnected = false` ‚Üí —Å–æ–±—ã—Ç–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è.

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï:

### **1. –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ postMessage**

**–§–∞–π–ª:** `frontend/src/pages/IframePage.tsx`

```typescript
// –ö–æ–≥–¥–∞ iframe –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω
useEffect(() => {
  const iframe = iframeRef.current;
  if (!iframe || !iframeUrl) return;

  const handleLoad = () => {
    setTimeout(() => {
      if (iframe.contentWindow && accessToken) {
        iframe.contentWindow.postMessage({
          type: 'LOGINUS_AUTH_TOKEN',
          token: accessToken,
          timestamp: Date.now(),
        }, '*');
      }
    }, 500);
  };

  iframe.addEventListener('load', handleLoad);
}, [iframeUrl, accessToken]);
```

### **2. –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ postMessage**

**–§–∞–π–ª:** `calculator-plugin-advanced/index.html`

```javascript
let authToken = null;

// –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞
window.addEventListener('message', (event) => {
  if (event.data.type === 'LOGINUS_AUTH_TOKEN') {
    authToken = event.data.token; // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
    logEvent('üîë –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞');
    updateStatus(true, '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
    backendConnected = true;
    checkBackendConnection(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  }
});

// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –∏–∑ postMessage (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) –∏–ª–∏ localStorage (fallback)
function getAuthToken() {
  if (authToken) return authToken; // ‚úÖ –°–Ω–∞—á–∞–ª–∞ —Ç–æ–∫–µ–Ω –∏–∑ postMessage
  // Fallback: localStorage
  // ...
}
```

---

## üöÄ –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨:

### **–®–ê–ì 1: –û–±–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω**
1. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –ø–ª–∞–≥–∏–Ω —á–µ—Ä–µ–∑ `/ru/admin/extensions`
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ **–ù–û–í–´–ô** `calculator-advanced.zip`
3. –û–±–Ω–æ–≤–∏—Ç–µ –ø—É–Ω–∫—Ç –º–µ–Ω—é

### **–®–ê–ì 2: –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä**
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø—É–Ω–∫—Ç –º–µ–Ω—é —Å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º

### **–®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä**
- –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å **üü¢ –∑–µ–ª—ë–Ω–∞—è —Ç–æ—á–∫–∞** (–Ω–µ –∫—Ä–∞—Å–Ω–∞—è!)
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–µ–∫—Å—Ç **"–ü–æ–¥–∫–ª—é—á–µ–Ω–æ"** (–Ω–µ "–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞"!)

### **–®–ê–ì 4: –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ**
1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: `2 + 2 =`
2. –í –ª–æ–≥–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
   ```
   ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ: 2 + 2 = 4
   ‚úÖ –°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: CALCULATOR_CALCULATION_DONE
   ```

### **–®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Network tab**
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Network
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ
3. –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø—Ä–æ—Å: `POST /api/v2/events/emit` ‚úÖ

### **–®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ backend**
```powershell
# –õ–æ–≥–∏
docker logs -f loginus-api-new | Select-String -Pattern "CALCULATOR"

# –ë–î
docker exec loginus-db psql -U loginus -d loginus_dev -c "SELECT COUNT(*) FROM event_logs WHERE \"eventName\" LIKE 'CALCULATOR%';"
```

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç üü¢ "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ"
- ‚úÖ –í –ª–æ–≥–µ: "üîë –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞"
- ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–±—ã—Ç–∏—è –≤ backend
- ‚úÖ –í Network tab –≤–∏–¥–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ `/api/v2/events/emit`
- ‚úÖ –í backend –ª–æ–≥–∞—Ö: `[EventBusService] Event dispatched: CALCULATOR_CALCULATION_DONE`
- ‚úÖ –í –ë–î –ø–æ—è–≤–ª—è—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ –≤ `event_logs`

---

## üìÅ –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´:

1. ‚úÖ `frontend/src/pages/IframePage.tsx` - –ø–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ postMessage
2. ‚úÖ `calculator-plugin-advanced/index.html` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ postMessage
3. ‚úÖ `calculator-advanced.zip` - –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∞—Ä—Ö–∏–≤

---

## üéØ –ò–¢–û–ì:

**–ü—Ä–æ–±–ª–µ–º–∞:** Iframe –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ localStorage —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞  
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ postMessage –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è –∫ iframe  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–û–±–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ!** üöÄ

