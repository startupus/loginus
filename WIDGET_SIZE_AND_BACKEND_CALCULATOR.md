# ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û: –†–∞–∑–º–µ—Ä –≤–∏–¥–∂–µ—Ç–∞ + Backend API –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞

## üéØ –ß–¢–û –°–î–ï–õ–ê–ù–û:

### 1Ô∏è‚É£ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞–∑–º–µ—Ä –≤–∏–¥–∂–µ—Ç–∞ (–∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ)**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∏–¥–∂–µ—Ç—ã –∏–º–µ–ª–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É –∏ –Ω–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `ResizeObserver` –≤ `PluginWidget.tsx` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ iframe
- ‚úÖ –í–∏–¥–∂–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–≤–æ–π —Ä–∞–∑–º–µ—Ä —á–µ—Ä–µ–∑ `postMessage` —Å —Ç–∏–ø–æ–º `WIDGET_RESIZE`
- ‚úÖ –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã—Å–æ—Ç—É iframe
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞: 200px, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è: 600px

**–§–∞–π–ª—ã:**
- ‚úÖ `frontend/src/components/Admin/AdminWidgets/PluginWidget.tsx` - —Å–ª—É—à–∞—Ç–µ–ª—å postMessage –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞
- ‚úÖ `calculator-plugin-advanced/index.html` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —á–µ—Ä–µ–∑ postMessage
- ‚úÖ `weather-widget/widget.html` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —á–µ—Ä–µ–∑ postMessage

---

### 2Ô∏è‚É£ **–õ–æ–≥–∏–∫–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ backend**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —á–µ—Ä–µ–∑ `eval()`, —á—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –°–æ–∑–¥–∞–Ω `CalculatorController` –≤ backend
- ‚úÖ Endpoint: `POST /api/v2/calculator/calculate`
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–±–µ–∑ `eval`)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ EventBus
- ‚úÖ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ—Ç backend API –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

**–§–∞–π–ª—ã:**
- ‚úÖ `backend/src/core/extensions/calculator.controller.ts` - –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
- ‚úÖ `backend/src/core/core.module.ts` - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω `CalculatorController`
- ‚úÖ `backend/src/core/events/events/system.events.ts` - –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–æ–±—ã—Ç–∏—è `CALCULATION_DONE` –∏ `CALCULATION_ERROR`
- ‚úÖ `calculator-plugin-advanced/index.html` - –æ–±–Ω–æ–≤–ª—ë–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è backend API

---

## üìä –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:

### **Backend API:**

```typescript
POST /api/v2/calculator/calculate
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "expression": "2 + 2"
}

Response:
{
  "success": true,
  "data": {
    "expression": "2 + 2",
    "result": "4",
    "timestamp": "2025-11-29T21:30:00.000Z"
  }
}
```

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ:**

```typescript
// Backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ –≤–º–µ—Å—Ç–æ eval()
private safeEvaluate(expression: string): number {
  // –û—á–∏—Å—Ç–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –æ—Ç –æ–ø–∞—Å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
  const cleaned = expression.replace(/[^0-9+\-*/().\s]/g, '');
  
  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Function –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
  const result = Function(`"use strict"; return (${cleaned})`)();
  
  return result;
}
```

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è:**

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:
- ‚úÖ `plugin.calculation_done` - —É—Å–ø–µ—à–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ
- ‚úÖ `plugin.calculation_error` - –æ—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è

–°–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –ë–î —á–µ—Ä–µ–∑ `EventLoggerService`.

---

## üöÄ –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨:

### **–®–ê–ì 1: –û–±–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞**
1. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –ø–ª–∞–≥–∏–Ω —á–µ—Ä–µ–∑ `/ru/admin/extensions`
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ **–ù–û–í–´–ô** `calculator-advanced.zip`
3. –û–±–Ω–æ–≤–∏—Ç–µ –ø—É–Ω–∫—Ç –º–µ–Ω—é

### **–®–ê–ì 2: –û–±–Ω–æ–≤–∏—Ç–µ –≤–∏–¥–∂–µ—Ç –ø–æ–≥–æ–¥—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
1. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –≤–∏–¥–∂–µ—Ç
2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ **–ù–û–í–´–ô** `moscow-weather-widget.zip`

### **–®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –≤–∏–¥–∂–µ—Ç–∞**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–∞—à–±–æ—Ä–¥: `/ru/dashboard`
2. –í–∏–¥–∂–µ—Ç –ø–æ–≥–æ–¥—ã –¥–æ–ª–∂–µ–Ω **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å—Å—è –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
3. **–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å** —Å–∫—Ä–æ–ª–ª–∞ –∏–ª–∏ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### **–®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —á–µ—Ä–µ–∑ –º–µ–Ω—é
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ: `2 + 2 =`
3. **–í–ê–ñ–ù–û:** –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Network
4. –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø—Ä–æ—Å: `POST /api/v2/calculator/calculate` ‚úÖ

### **–®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ backend**
```powershell
# –õ–æ–≥–∏
docker logs -f loginus-api-new | Select-String -Pattern "calculator|CALCULATION"

# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# [CalculatorController] Calculation: 2 + 2 = 4
# [EventBusService] Event dispatched: plugin.calculation_done
```

### **–®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î**
```powershell
docker exec loginus-db psql -U loginus -d loginus_dev -c "SELECT \"eventName\", data->>'expression' as expression, data->>'result' as result, \"createdAt\" FROM event_logs WHERE \"eventName\" LIKE 'plugin.calculation%' ORDER BY \"createdAt\" DESC LIMIT 5;"
```

---

## üìÅ –ò–ó–ú–ï–ù–Å–ù–ù–´–ï –§–ê–ô–õ–´:

### **Frontend:**
1. ‚úÖ `frontend/src/components/Admin/AdminWidgets/PluginWidget.tsx` - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä
2. ‚úÖ `calculator-plugin-advanced/index.html` - backend API + –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
3. ‚úÖ `weather-widget/widget.html` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞

### **Backend:**
1. ‚úÖ `backend/src/core/extensions/calculator.controller.ts` - –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
2. ‚úÖ `backend/src/core/core.module.ts` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
3. ‚úÖ `backend/src/core/events/events/system.events.ts` - –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è

### **–ê—Ä—Ö–∏–≤—ã:**
1. ‚úÖ `calculator-advanced.zip` - –æ–±–Ω–æ–≤–ª—ë–Ω
2. ‚úÖ `moscow-weather-widget.zip` - –æ–±–Ω–æ–≤–ª—ë–Ω

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢:

### **–†–∞–∑–º–µ—Ä –≤–∏–¥–∂–µ—Ç–∞:**
- ‚úÖ –í–∏–¥–∂–µ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
- ‚úÖ –ù–µ—Ç —Å–∫—Ä–æ–ª–ª–∞ –∏–ª–∏ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞: 200px, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è: 600px
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ (–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä, –ø–æ–≥–æ–¥–∞, –∏ —Ç.–¥.)

### **Backend API:**
- ‚úÖ –í—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –Ω–∞ backend
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ (–±–µ–∑ `eval()` –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ –ë–î
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:

**–î–æ:**
```javascript
// ‚ùå –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ - eval() –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
const result = eval(safeExpression);
```

**–ü–æ—Å–ª–µ:**
```typescript
// ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ - –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ backend
const result = Function(`"use strict"; return (${cleaned})`)();
// + –û—á–∏—Å—Ç–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –æ—Ç –æ–ø–∞—Å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
```

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
- ‚úÖ –í–∏–¥–∂–µ—Ç—ã –∞–¥–∞–ø—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
- ‚úÖ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç backend API
- ‚úÖ –í Network tab –≤–∏–¥–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ `/api/v2/calculator/calculate`
- ‚úÖ –í backend –ª–æ–≥–∞—Ö –≤–∏–¥–Ω—ã –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
- ‚úÖ –í –ë–î –ø–æ—è–≤–ª—è—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ —Å —Å–æ–±—ã—Ç–∏—è–º–∏ `plugin.calculation_done`

**–û–±–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ!** üöÄ

