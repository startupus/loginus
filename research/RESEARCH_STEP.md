## Research – i18n regression (2025-11-23)

### Context
- Пользователь сообщает, что раньше (2 дня назад) переключение языка работало на всех страницах (`/en/data`, `/en/admin/backup`), а сейчас часть компонентов остаётся на русском или показывает ключи.
- Проверка браузером показала: `window.i18next` отсутствует, а в секциях отображаются строки вида `personalData.documents.title`. Это симптом упрощённой i18n-конфигурации.
- Файл `frontend/src/services/i18n/config.ts` откатился к статичному варианту, который загружает только `ru.json` / `en.json` и не поддерживает модульную загрузку. Именно эта версия была заменена ранее на динамическую (коммит `3831aa0`), обеспечивающую загрузку модулей (`profile`, `personalData`, `admin` и т.д.).

### Требования
1. Вернуть полноценную конфигурацию i18n из рабочего коммита (≈2 дня назад) с динамической загрузкой модулей.
2. Убедиться, что `changeLanguage` подгружает все модули и триггерит `languageChanged`, чтобы компоненты перерисовывались.
3. Проверить, что `PageTemplate`, `Sidebar`, `DataSection`, `DocumentsGrid`, `AddressesGrid` и др. потребляют ключи, а не готовые строки.
4. Обеспечить работу переключения языка на `/en/data`, `/ru/data`, `/en/admin/backup`.

### Наблюдения
- В `config.ts` из HEAD нет динамики, поэтому `personalData` модуль не грузится, и компоненты получают сырые ключи.
- В браузерном логе отсутствуют запросы к `/api/v2/translations`, значит фронтенд сейчас ожидает локальные JSON модули (как в коммите `3831aa0`).
- Sidebar элементы всё ещё на русском, т.к. `React.useMemo` в `PageTemplate` не пересобирает массив при смене языка (не было зависимости от `i18n.language` / `t`).

### План действий
1. Восстановить `frontend/src/services/i18n/config.ts` из коммита `3831aa0` (модульная загрузка + кеш).
2. Убедиться, что `availableModules` включает `profile`, `personalData`, `admin`, `work`, `support`, `payment`, `help` и т.д.
3. Переподключить i18n через `frontend/src/services/i18n/index.ts` (использовать `./config`, не `config-integrated`).
4. Перепроверить компоненты:
   - `PageTemplate` / `Sidebar` — хранить ключи, пересобирать при смене языка (`useMemo` зависим от `i18n.language` + `t`).
   - `DataSection`, `DocumentsGrid`, `AddressesGrid` — не передавать готовые строки, а вычислять `t(...)` при рендере.
5. Перезапустить `npm run dev`, сделать hard reload, протестировать `/ru/data` и `/en/data`.

### Риски
- При возврате динамической конфигурации нужно следить, чтобы `loadedModules` корректно отмечал `ru`-модули (иначе начнутся лишние загрузки).
- В `missingKey` необходимо обрабатывать ключи `admin.*`, иначе админские страницы вновь останутся частично непереведёнными.
- Локальные кэши (Vite, браузер, localStorage) могут удерживать старые строки — потребуется очистка `localStorage` (`loginus-language`) и hard reload.

### Реализация (2025-01-XX)

#### Выполненные задачи ✅

1. **Консолидация i18n на API v2**
   - Переписан `config.ts` для использования API v2 как основного источника
   - Используется `loadModule` и `loadModules` из `v2/loader.ts` с fallback на статические файлы
   - Все модули загружаются через `/api/v2/translations/:locale/:module`

2. **Удаление дубликатов**
   - Удален `config-integrated.ts`
   - `index.ts` экспортирует из единого `config.ts`

3. **Единый компонент LanguageSwitcher**
   - Создан `LanguageSwitcher` в `design-system/composites`
   - Используется в `Sidebar` и `AdminSidebar`
   - Автоматически синхронизирует язык с URL

4. **Реактивность Layout-компонентов**
   - `PageTemplate`: `useMemo` с зависимостями `[t, currentLang, location.pathname, i18n.language]`
   - `AdminPageTemplate`: обернуто в `useMemo` с зависимостями от языка

5. **Бизнес-компоненты**
   - `DataSection`, `DocumentsGrid`, `AddressesGrid` используют `t()` на рендере

6. **Недостающие ключи**
   - Ключи `personalData.documents.diplomas` и `personalData.documents.certificates` присутствуют во всех источниках

7. **E2E тесты**
   - Созданы Playwright тесты для проверки смены языка

#### Архитектурные решения

- **Источник переводов**: API v2 (`/api/v2/translations/:locale/:module`) из backend-mock (Nest)
- **Fallback**: Локальные JSON файлы в `frontend/src/services/i18n/locales/`
- **Кэш**: IndexedDB через `v2/cache.ts`

#### Результат

Все задачи выполнены. Система i18n консолидирована на API v2 с единым компонентом переключения языка и правильной реактивностью компонентов.

---

## Research – Наведение порядка в i18n на /dashboard (2025-01-23)

### Context
- Пользователь сообщает, что на `/dashboard` не все модули переключают перевод при смене языка (`http://localhost:3000/en/dashboard`)
- В проекте есть артефакты, которые подлежат удалению
- Необходимо привести все в порядок на примере одной страницы (`/dashboard`) и транслировать метод на весь проект
- Прошлым спринтом была выполнена консолидация i18n на API v2, но остались проблемы с реактивностью компонентов

### Требования
1. Привести `/dashboard` к эталонному состоянию с полной поддержкой i18n
2. Удалить артефакты (пустые директории, устаревшие документы)
3. Задокументировать метод для тиражирования на остальные страницы
4. Обеспечить корректное форматирование чисел/дат в зависимости от языка

### Наблюдения
- В компонентах Dashboard используются хардкодные локали (`'ru-RU'`) для форматирования чисел/дат
- Некоторые компоненты используют сырые пути (`Link to="/mail"`) вместо `buildPathWithLang`
- `LanguageSwitcher` не сохраняет query/hash при переключении языка
- `I18N_MODE` по умолчанию `static`, но должен быть `hybrid` для работы с API v2
- В `AVAILABLE_MODULES` отсутствуют некоторые модули (например, `payment`, `admin`)

### Риски
- При изменении форматирования чисел/дат может потребоваться обновление тестов
- Переключение языка может сломать навигацию, если не сохранять query/hash
- Удаление артефактов может затронуть другие части системы

### Архитектурные решения
- Создать единую утилиту `frontend/src/utils/intl/formatters.ts` для форматирования чисел/дат с учетом текущего языка
- Использовать `buildPathWithLang` везде, где есть навигация
- Синхронизировать `document.documentElement.lang` с текущим языком
- Расширить `AVAILABLE_MODULES` в соответствии с реальными модулями API v2

---

## Research – Проблема с переводами на /en/dashboard (2025-01-23)

### Context
- Пользователь сообщает, что на `/en/dashboard` элементы Sidebar (например, "Поддержка") остаются на русском языке
- Также отображаются ключи переводов (`personalData.documents.title`) вместо переведенных строк
- URL корректный (`http://localhost:3000/en/dashboard`), но язык не применяется

### Наблюдения
1. **Проблема с Sidebar**: В `PageTemplate.tsx` функция `convertMenuItemToSidebarItem` использует `item.label` напрямую из API (`menu-settings.json`), где хранятся хардкодные русские строки ("Поддержка", "Профиль" и т.д.)
2. **Проблема с ключами**: Ключ `personalData.documents.title` существует в английской локали (`en/profile.json`), но модуль `profile` может не загружаться для английского языка при инициализации
3. **Меню из API**: API возвращает меню с хардкодными русскими `label`, но должен использоваться `systemId` для перевода через `t('sidebar.{systemId}')`

### Требования
1. Исправить `PageTemplate.tsx` - использовать переводы через `t()` на основе `systemId` вместо хардкодных `label` из API
2. Убедиться, что модуль `profile` загружается для английского языка при инициализации
3. Проверить, что все ключи переводов присутствуют в английской локали
4. Написать Playwright тест для проверки английского языка на `/en/dashboard`

### Решение
- В `convertMenuItemToSidebarItem` использовать `t('sidebar.{systemId}')` вместо `item.label`
- Fallback на `item.label` только если `systemId` отсутствует или перевод не найден
- Убедиться, что `CRITICAL_MODULES` включает `profile` для загрузки при инициализации


---

## Research – Дублирование ключей profile i18n (2025-11-23)

### Context
- На `/en/dashboard` компоненты `DocumentsGrid` и `AddressesGrid` показывают сырые ключи, хотя в статических fallback-файлах переводы присутствуют.
- Запрос к `/api/v2/translations/en/profile` возвращает `personalData` как строку `"Personal data"`, без вложенных секций `documents` и `addresses`.
- Файл `backend-mock/data/translations/v2/en/profile.json` содержит две записи `personalData`: первая — объект с полным набором ключей, вторая — строка. При парсинге JSON второе значение перезаписывает первое.

### Best practice
- JSON-спецификация (ECMA-404) допускает дублирующиеся ключи, но стандарт трактует это как неопределённое поведение. Реализации парсеров (в т.ч. `JSON.parse`) оставляют последнее значение, поэтому вложенный объект теряется.
- Рекомендации i18next: каждый ключ должен быть уникальным и иметь единственный тип значения. Для отдельных строк используют отдельные ключи (`profile.sectionTitle`), а не переопределение родительского объекта.

### Findings
1. Backend отдаёт урезанный модуль `profile`, из-за чего фронтенд не получает `personalData.documents` / `personalData.addresses`.
2. Та же проблема присутствует в русской локали (`backend-mock/data/translations/v2/ru/profile.json`).
3. Фронтенд fallback-файлы (`frontend/src/services/i18n/locales/en/profile.json`) корректны, поэтому в офлайн-режиме переводы есть.

### План
1. Нормализовать JSON-файлы в `backend-mock/data/translations/v2/{en,ru}/profile.json`, удалив дубликаты и перенеся строки (`personalData`, `personalDataDescription` и др.) внутрь объекта.
2. Добавить автоматическую проверку на дублирующиеся ключи для остальных модулей переводов.
3. Перезапустить backend-mock и верифицировать ответ `/api/v2/translations/en/profile`.
4. Обновить i18n-чеклисты: отдельный пункт про валидацию JSON на уникальность ключей.

### Риски
- Возможны другие скрытые дубликаты; потребуется дополнительный аудит.
- После изменения структуры нужно убедиться, что фронтенд не полагается на строковый ключ `profile.personalData`.

### Решение
- Привести структуру модулей к виду, где родительский ключ `personalData` — объект с вложенными `title`, `description`, `documents`, `addresses` и т.д.
- Для отдельных строк использовать уникальные ключи (`profile.section.personalData`, `profile.labels.personalData`).
- Задokumentировать правило в корпоративных гайдах, чтобы предотвратить повтор.

---
